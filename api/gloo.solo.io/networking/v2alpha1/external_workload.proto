// Create an in-mesh identity for workloads that are external to a Kubernetes workload
// cluster to enable routing to and from those workloads in Gloo Mesh.
// For example, after you [onboard a VM to Gloo Mesh](https://docs.solo.io/gloo-mesh-enterprise/main/setup/prod/ext_workload_int/),
// you might create an ExternalWorkload to represent a set of workloads
// that run on the virtual machine or bare metal instance.
// When an ExternalWorkload is defined for a given workspace, it can be referenced in:
// - VirtualDestination resources, as an upstream destination
// - AccessPolicy resources, as an allowed client
// - AccessPolicy resources targeting external workloads that match workload selectors
//
// **Example**: This example provisions an identity for services that listen on port 5000
// and that run either on a GCP VM that uses the specified cloud IAM service account, or
// an AWS VM that is in the specified security group ID.
// The identity is created in the `vm-config` namespace of the `workload-cluster`.
// ```
// apiVersion: networking.gloo.solo.io/v2alpha1
// kind: ExternalWorkload
// metadata:
//   labels:
//     app: http-server
//     version: v1
//   name: http-server
//   namespace: vm-config
// spec:
//   connectedClusters:
//     workload-cluster: vm-config
//   identitySelector:
//     gcp:
//       - serviceAccount: <GCP_VM_service_account>
//     aws:
//       - securityGroupId: <AWS_security_group_id>
//   ports:
//     - name: http
//       number: 5000
// ```
syntax = "proto3";

package networking.gloo.solo.io;

import "extproto/ext.proto";
import "google/protobuf/wrappers.proto";
import "github.com/solo-io/solo-apis/api/gloo.solo.io/common/v2/selectors.proto";
import "github.com/solo-io/solo-apis/api/gloo.solo.io/common/v2/status.proto";

option go_package = "github.com/solo-io/solo-apis/client-go/networking.gloo.solo.io/v2alpha1";

option (extproto.equal_all) = true;
option (extproto.hash_all) = true;
option (extproto.clone_all) = true;

// Specifications for the external workload.
message ExternalWorkloadSpec {

  // Ports that the external workloads listen on.
  repeated Port ports = 1;

  // The conditions under which an external workload is selected. For example, you might
  // select a Google Cloud Platform (GCP) VM by specifying `gcp.serviceAccount: <VM_service_account>`.
  // This field is optional when you use a join token to attest the external workload.
  // If you specify multiple identity selectors, an external workload is selected when at least
  // one of the selectors matches.
  IdentitySelector identity_selector = 2;

  // A map of cluster names to the namespace within the cluster that the external workload
  // is registered in. To scope the external workload to multiple registered clusters, multiple
  // cluster-namespace pairs can be specified. However, within a cluster, only a single
  // namespace can be used to register the external workload.
  map<string,string> connectedClusters = 3;

  // Optional: Readiness probe for the external workload.
  Probe readiness_probe = 4;

  // The port on the backing external workload.
  message Port {
    // The logical name assigned to the port.
    string name = 1;

    // The protocol of the port.
    // Supported protocols: HTTP, HTTPS, GRPC, HTTP2, MONGO, TCP, TLS
    string protocol = 2;

    // The port number. Must be in the range 1 - 65535.
    uint32 number = 3;
  }

  // The conditions under which an external workload is selected. For example, you might
  // select a Google Cloud Platform (GCP) VM by specifying `gcp.serviceAccount: <VM_service_account>`.
  // This field is optional when you use a join token to attest the external workload.
  // If you specify multiple selectors, an external workload is selected when at least
  // one of the selectors matches.
  message IdentitySelector {

    // Optional: Selector for external workloads running in AWS.
    repeated AWS aws = 1;

    // Optional: Selector for external workloads running in GCP.
    repeated GCP gcp = 2;

    // Optional: Selector for external workloads running in Azure.
    repeated Azure azure = 3;

    // Optional: Join token configuration to attest the external workload.
    JoinToken join_token = 4;

    // Selector for external workloads that run in AWS.
    // If multiple fields are specified, an external workload is selected only when all match. <!--line 34-35 says the opposite?-->
    message AWS {

      // Optional: The IAM role within the instance profile of the external workload.
      string iam_role = 1;

      // Optional: The name of the security group associated with the external workload.
      string security_group_name = 2;

      // Optional: The ID of the security group associated with the external workload.
      string security_group_id = 3;

      // Optional: The ID of the AMI used to launch the external workload.
      string image_id = 4;

      // Optional: The ID of the external workload instance.
      string instance_id = 5;

      // Optional: The availability zone in which the external workload is running.
      string zone = 6;

      // Optional: The region where the external workload is running.
      string region = 7;

      // The tag applied as a key to the external workload.
      Tag tag = 8;

      // The tag applied as a key-value pair to the external workload.
      message Tag {
        // The key of the tag.
        string key = 1;

        // The value of the tag.
        string value = 2;
      }
    }

    // Selector for external workloads that run in GCP.
    // If multiple fields are specified, an external workload is selected only when all match. <!--line 34-35 says the opposite?-->
    message GCP {

      // Optional: The service account associated with the external workload.
      string service_account = 1;

      // Optional: Name of the external workload instance.
      string name = 2;

      // Optional: The tag applied as a key to the external workload.
      string tag = 3;

      // Optional: The ID of the project containing the external workload.
      string project_id = 4;

      // Optional: The availability zone in which the external workload is running.
      string zone = 5;

      // Optional: The label applied as a key-value pair to the external workload.
      // The value for the key is optional.
      Label label = 6;

      // The label applied as a key-value pair to the external workload.
      // The value for the key is optional.
      message Label {
        // The key of the label.
        string key = 1;

        // The value of the label.
        string value = 2;
      }
    }

    // Selector for external workloads that run in Azure.
    // If multiple fields are specified, an external workload is selected only when all match. <!--line 34-35 says the opposite?-->
    message Azure {

      // Optional: The subscription ID of the external workload.
      string subscription_id = 1;

      // Optional: The name of the security group associated with the external workload.
      // If specified, the `resourceGroup` field must also be specified.
      string security_group = 2;

      // Optional: The name of the virtual network the external workload belongs to.
      // If specified, the `resourceGroup` field must also be specified.
      string virtual_network = 3;

      // Optional: The name of the subnet in the virtual network the external workload belongs to.
      // If specified, the `resourceGroup` and `virtualNetwork` fields must also be specified.
      string subnet = 4;

      // Optional: The name of the external workload instance.
      // If specified, the `resourceGroup` field must also be specified.
      string name = 5;

      // Optional: The resource group the external workload belongs to.
      // The resource group does not act as a selector,
      // but is used in conjunction with the other fields.
      // Must be specified if the `securityGroup`, `virtualNetwork`, `subnet`, or `name` fields are specified.
      string resource_group = 6;
    }

    message JoinToken {

      // Optional: Enable the use of join tokens to attest the external workload.
      // Defaults to false.
      bool enable = 1;
    }
  }

  // A health check to perform against an external workload
  // to determine whether it is ready to receive traffic.
  message Probe {

    // Optional: Number of seconds after the external workload startup before the probes are initiated.
    // Defaults to 0 seconds.
    google.protobuf.UInt32Value initial_delay_seconds = 1;

    // Optional: Number of seconds after which the probe times out.
    // Defaults to 1 second. Minimum value is 1 second.
    google.protobuf.UInt32Value timeout_seconds = 2;

    // How often (in seconds) to perform the probe.
    // Defaults to 10 seconds. Minimum value is 1 second.
    google.protobuf.UInt32Value period_seconds = 3;

    // Minimum consecutive successes for the probe to be considered successful after having failed.
    // Defaults to 1.
    google.protobuf.UInt32Value success_threshold = 4;

    // Minimum consecutive failures for the probe to be considered failed after having succeeded.
    // Defaults to 3.
    google.protobuf.UInt32Value failure_threshold = 5;

    // The handler corresponding to the probe. Specify only one of: httpGet, tcpSocket, exec
    oneof handler {

        // Configuration for an HTTP probe request.
        HTTPGetConfig http_get = 7;

        // Configuration for a TCP socket probe.
        TCPSocketConfig tcp_socket = 8;

        // Configuration for an exec command probe.
        ExecConfig exec = 9;
    }

    // Configuration for an HTTP GET probe request.
    message HTTPGetConfig {

      // Number of the port to access. Must be in the range 1 - 65535.
      uint32 port = 1;

      // Optional: Path to access on the HTTP server.
      string path = 2;

      // Optional: Scheme to use for connecting to the host.
      // Defaults to HTTP.
      Scheme scheme = 3;

      // Optional: Custom headers to set in the request. HTTP allows repeated headers.
      repeated HTTPHeader http_headers = 4;

      // Scheme to use for connecting to the host.
      enum Scheme {
        // Use the `http://` scheme for the connection.
        HTTP = 0;

        // Use the `https://` scheme for the connection.
        HTTPS = 1;
      }
    }

    // A custom header to use in HTTP probes.
    message HTTPHeader {

      // The header field name.
      string name = 1;

      // The header field value.
      string value = 2;
    }

    // Configuration for a TCP socket probe.
    message TCPSocketConfig {

      // Optional: Host to connect to. Defaults to `localhost`.
      string host = 1;

      // Number of the port to access. Must be in the range 1 - 65535.
      uint32 port = 2;
    }

    // Configuration for an exec command probe.
    message ExecConfig {

      // Command to run. An exit status of zero (0) is considered healthy, and a non-zero status is considered unhealthy.
      repeated string command = 1;
    }
  }
}

// The status of the ExternalWorkload after it is applied to your Gloo environment.
message ExternalWorkloadStatus {
  // The state and workspace conditions of the applied resource.
  .common.gloo.solo.io.Status common = 1;

  // A map of policy GVK to the number of policies that are applied on this resource,
  // sorted by GVK.
  map<string, uint32> num_applied_policies = 2;

  // Name of the workspace that owns this ExternalWorkload
  string owned_by_workspace = 3;
}

// The resources that the applied resource selects.
message ExternalWorkloadReport {
  map<string, .common.gloo.solo.io.Report> workspaces = 1;

  // A map of policy GVK to policy references for all the policies that are
  // applied on this resource.
  map<string, .common.gloo.solo.io.AppliedDestinationPortPolicies> applied_destination_policies = 2;

  // The name of the workspace that owns the ExternalWorkload.
  string owner_workspace = 3;
}
